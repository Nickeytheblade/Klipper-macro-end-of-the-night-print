[gcode_macro END_PRINT_NIGHT_NIGHT]
description: End print and shutdown once all fans have stopped
gcode:
    # Move toolhead up and park
    G91
    G1 Z10 F600
    G90
    G1 X0 Y200 F6000

    # Turn off heaters
    M104 S0
    M140 S0
    M106 S0

    # Wait for all fans to reach 0% duty cycle
    {% set cooldown_complete = False %}
    {% while not cooldown_complete %}
        {% set cooldown_complete = (
            printer.fan.speed == 0
            and (printer.fan_generic.controller_fan.speed|default(0)) == 0
            and (printer.fan_generic.hotend_fan.speed|default(0)) == 0
        ) %}
        {% if not cooldown_complete %}
            M400
            G4 P2000  # wait 2 seconds before checking again
        {% endif %}
    {% endwhile %}

    # Send shutdown command (adjust for your system)
    {action_call_remote_method("shutdown")}
